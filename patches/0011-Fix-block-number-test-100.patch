From 23eed3437ee76dceb0d64f402cb8ed48985392bf Mon Sep 17 00:00:00 2001
From: Vladimir Lelicanin <v.lelicanin@sae.edu>
Date: Sat, 5 May 2018 22:35:25 +0200
Subject: [PATCH 11/22] Fix/block number test (#100)

Fixed test for checking block number
---
 modules/Utilities.js           | 20 ++++++++++++++++++++
 test/modules/utilities.test.js |  6 +++++-
 2 files changed, 25 insertions(+), 1 deletion(-)

diff --git a/modules/Utilities.js b/modules/Utilities.js
index 67e5d6d..be0f0ab 100644
--- a/modules/Utilities.js
+++ b/modules/Utilities.js
@@ -533,6 +533,26 @@ class Utilities {
             });
         });
     }
+
+    /**
+     * Web3 Hex to number
+     * @param hex
+     * @returns {number}
+     */
+    static hexToNumber(hex) {
+        const web3 = new Web3(new Web3.providers.HttpProvider(`${config.rpc_node_host}:${config.rpc_node_port}`));
+        return web3.utils.hexToNumber(hex);
+    }
+
+    /**
+     * Web3 Number to hex
+     * @param num
+     * @returns {string}
+     */
+    static numberToHex(num) {
+        const web3 = new Web3(new Web3.providers.HttpProvider(`${config.rpc_node_host}:${config.rpc_node_port}`));
+        return web3.utils.numberToHex(num);
+    }
 }
 
 module.exports = Utilities;
diff --git a/test/modules/utilities.test.js b/test/modules/utilities.test.js
index d971aba..689f5ad 100644
--- a/test/modules/utilities.test.js
+++ b/test/modules/utilities.test.js
@@ -52,7 +52,11 @@ describe('Utilities module', () => {
         const responseFromApi = await Utilities.getBlockNumberInfuraRinkebyApiMethod();
         assert.equal(responseFromApi.statusCode, 200);
         const responseFromWeb3 = await Utilities.getBlockNumberFromWeb3();
-        assert.equal(responseFromApi.body.result, responseFromWeb3);
+        // assert.equal(responseFromApi.body.result, responseFromWeb3);
+        // Not possible to match exactly the block every time as new ones get mined,
+        // so range is used
+        expect(Utilities.hexToNumber(responseFromApi.body.result))
+            .to.be.closeTo(Utilities.hexToNumber(responseFromWeb3), 5);
     });
 
     it('loadSelectedBlockchainInfo()', async () => {
-- 
2.13.5 (Apple Git-94)

